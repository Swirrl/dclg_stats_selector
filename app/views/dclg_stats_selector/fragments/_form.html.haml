= row do
	.pmd_box_full
		.spin(style="display: none;")
			(preparing data)
			= image_tag 'publish_my_data/dclg_stats_selector/spinner.gif'

#build-fragment
	= row do
		.pmd_box_full
			.predicate Source Dataset
			%strong
				= @dataset.title
			= link_to '(change dataset)', datasets_selector_fragments_path(@selector), id: 'pick-again', remote: true

	= form_tag selector_fragments_path(@selector), id: 'bf' do
		= row do
			.pmd_box_full{style:"margin-top:24px;"}
				.predicate Selected data
				= form_tag selector_fragments_path(@selector), id: 'bf' do
					= hidden_field_tag :dataset_uri, @dataset.uri

				%p#no-filters
					%em All possible combinations of dataset dimension are currently selected. To reduce the amount of data, select some dimension values to filter by.
				#filters(style="display: none;")
					%h3 Filtered by
					#filter-lists
						- @dimensions.each do |dimension|
							.dimension
								%em.all-values
									All
									= dimension.label.pluralize
								%ul(style="display: none;")
									%li.dimension-label= dimension.label
									- dimension.values.each do |dimension_value|
										%li{'id' => dom_id_for_dimension_value(dimension_value, 'filter'), 'style' => 'display: none;'}
											= dimension_value[:label]
											= link_to '#', class: 'remove-dimension-value' do
												&times;
		= row do
			.pmd_box_full
				#filter-options
					%h2 Filter by &hellip;
					%ul#dimensions
						- @dimensions.each do |dimension|
							%li.dimension
								= hidden_field_tag "dataset_dimensions[#{dimension.uri}]", '', class: 'selected-values'
								= hidden_field_tag "all_dataset_dimensions[#{dimension.uri}]", dimension.values.map{|v| v[:uri]}.join(', ')
								%h3
									= dimension.label
								%ul
									- dimension.values.each do |dimension_value|
										%li{'id' => dom_id_for_dimension_value(dimension_value)}
											= link_to dimension_value[:label], '#', 'data-uri' =>  dimension_value[:uri], 'class' => 'dimension-value'
		= row do
			.pmd_box_full
				.submit.primary
					= submit_tag "Add #{column_count(@dimensions)} columns to spreadsheet", id: 'submit-fragment', class:'btn mini'

:javascript
	var addValueWithAnchor = function(anchor) {
		var uri = anchor.attr('data-uri'),
				input = anchor.parents('li.dimension').find('input.selected-values'),
				dimensionValues;

		if (input.val().length == 0) {
			dimensionValues = [uri];
		} else {
			dimensionValues = input.val().split(', ');
			dimensionValues.push(uri);
		}
		input.val(dimensionValues.join(', '));
	},
	removeValueWithAnchor = function(anchor) {
		var uri = anchor.attr('data-uri'),
				input = anchor.parents('li.dimension').find('input.selected-values'),
				dimensionValues = input.val().split(', '),
				idx;

		idx = dimensionValues.indexOf(uri);
		dimensionValues.splice(idx, 1);
		input.val(dimensionValues.join(', '));
	},
	calculateColumnCount = function() {
		var total = 1,
				dimCount,
				colPlural;

		$('#filter-lists ul').each(function(idx) {
			var ul = $(this);

			if (ul.is(':hidden')) {
				// all values
				dimCount = $('#dimensions li.dimension').eq(idx).find('li').size();
			} else  {
				// selected values
				dimCount = ul.find('li:visible').not('.dimension-label').size();
			}
			total = total * dimCount;
		});
		colPlural = (total == 1) ? 'column' : 'columns';
		$('input#submit-fragment').val('Add ' + total + ' ' + colPlural + ' of data');
	}

	$('a.dimension-value').click(function(e) {
		e.preventDefault();

		var filterOption = $(this).parent(),
				filter = $('#filter-' + filterOption.attr('id')),
				filterList = filter.parent();

		filterOption.hide();
		filter.show();
		if (filterList.is(':hidden')) {
			filterList.show();
			filterList.siblings('.all-values').hide();

			if ($('#filters').is(':hidden')) {
				$('#filters').show();
				$('#no-filters').hide();
			}
		}

		addValueWithAnchor($(this));
		calculateColumnCount();
	});

	$('a.remove-dimension-value').click(function(e) {
		e.preventDefault();

		var filter = $(this).parent(),
				filterOption = $('#' + filter.attr('id').replace('filter-', '')),
				filterList = filter.parent(),
				anchor;

		filter.hide();
		filterOption.show();

		if (!filter.siblings().not('.dimension-label').is(':visible')) {
			filterList.hide();
			filterList.siblings('.all-values').show();

			if (!$('#filter-lists .dimension ul').is(':visible')) {
				$('#filters').hide();
				$('#no-filters').show();
			}
		}

		anchor = filterOption.find('a');
		removeValueWithAnchor(anchor);
		calculateColumnCount();
	});

	$('#submit-fragment').click(function() {
		$('.spin').show();
		$('#bf').submit();
	});
	$('#pick-again').click(function() {
		$('.spin').show();
		$('#build-fragment').hide();
	});
